# Redis

## 问题

- 3种常用的缓存读写策略
- [旁路缓存模式]在写数据的过程中，可以先删除 cache ，后更新 db 么？
- [旁路缓存模式]在写数据的过程中，先更新 db，后删除 cache 就没有问题了么？
- 旁路缓存模式有什么缺陷？
- Redis有哪些数据结构?
- Redis 3 种特殊数据结构
- Redis持久化机制
- 什么是 RDB 持久化？
- RDB 创建快照时会阻塞主线程吗？
- 什么是 AOF 持久化？
- AOF 工作基本流程是怎样的？
- 持久化方式有哪些？
- AOF 为什么是在执行完命令之后记录日志？
- AOF 重写了解吗？
- 如何选择 RDB 和 AOF？
- redis应用
- 如何基于 Redis 实现分布式锁？
- 过期的数据的删除策略了解么？
- Redis 单线程模型了解吗？
- Redis 和 Memcached 的区别和共同点


### 3种常用的缓存读写策略

!!! tip "3种常用的缓存读写策略"

    - 旁路缓存模式
    
    同时维系 db 和 cache，并且是以 db 的结果为准
    
    - 读写穿透
    
    写的时候，先查cache，不存在则直接更新到db；cache存在，则更新cache，然后cache服务自己更新db
    
    读的时候，先查cache，读取到则返回；读取不到，则读取db，然后写入cache。
    
    
    - 异步缓存写入
    
    只更新缓存，异步批量更新db
    
    适合数据经常变化但对一致性要求没那么高的场景，比如浏览量、点赞量、消息队列的异步写入磁盘


### 在写数据的过程中，可以先删除 cache ，后更新 db 么

!!! tip "在写数据的过程中，可以先删除 cache ，后更新 db 么"

    不行，有可能存在其他并行的线程，没读取到cache，但是读取到db了，然后回写cache，造成不一致了


### 在写数据的过程中，先更新 db，后删除 cache 就没有问题了么？

!!! tip "在写数据的过程中，先更新 db，后删除 cache 就没有问题了么？"

    理论上来说还是可能会出现数据不一致性的问题，不过概率非常小，因为缓存的写入速度是比数据库的写入速度快很多。

### 旁路缓存模式有什么缺陷？

!!! tip "旁路缓存模式有什么缺陷？"
    
    - [x] 首次请求数据一定不在 cache 的问题
    
    解决办法：可以将热点数据可以提前放入 cache 中。
    
    - [x] 写操作比较频繁的话导致 cache 中的数据会被频繁被删除，这样会影响缓存命中率 。
    
    解决办法：1，使用锁来保证更新db同时更新缓存，适合缓存和db强一致场景。2，删除db的时候，给缓存一个短的超时时间，适合一致性要求不高的场景
    

### Redis有哪些数据结构

!!! tip "Redis有哪些数据结构"

    String（字符串）、List（列表）、Set（集合）、Hash（散列）、Zset（有序集合）
    
    - [x] String
    
    最常用，可以存储字符串。常用来存储session，token、分布式锁、简单限流等
    
    - [x] List
    
    一个双向链表，常用来做最新文章、最新动态、消息队列等
    
    - [x] Hash
    
    类似于hashMap，存储键值对，常用来存储用户信息、商品信息等
    
    - [x] Set
    
    无序集合，不可重复，能实现交集、并集、差集，常用于不能重复的数据或者共同好友等
    
    - [x] Sorted Set
    
    有序Set，常用于排序、排行榜等


### Redis 3 种特殊数据结构

!!! tip "Redis 3 种特殊数据结构"

    - [x] Bitmap
    
    存储二进制数字的数组，只需一个bit位，非常节省空间。常用保存状态信息，比如用户签到、活跃用户等
    
    - [x] HyperLogLog
    
    一种有名的基数计数概率算法,数量量巨大（百万、千万级别以上）的计数场景，比如每日/月网站访问ip统计
    
    - [x] 地理空间索引 geo
    
    主要用于存储地理位置信息，基于 Sorted Set 实现,可以轻松实现两个位置距离的计算、获取指定位置附近的元素等功能
    

### Redis持久化机制

!!! tip "Redis持久化机制"

    - 快照（RDB持久化）
    - 只追加文件（AOF）
    - 混合,aof重写的时候，会把rdb写入aof文件开头
    
### 什么是 RDB 持久化？

!!! tip "什么是 RDB 持久化？"

    创建快照来获得内存里面的数据在 某个时间点 上的副本，之后可以备份、可以复制到其它服务器、也可以留在原地以便重启时使用。
    
    在 redis.conf 中配置 save 900 1   900之后，如果有一个key发生变化，执行bgsave创建快照
    
### RDB 创建快照时会阻塞主线程吗？

!!! tip "RDB 创建快照时会阻塞主线程吗？"

    - save 阻塞
    - bgsave 不阻塞，子进程执行，默认选项
    
### 什么是 AOF 持久化？

!!! tip "什么是 AOF 持久化？"

    6.0之后默认开启，开启方式:appendonly yes
    
    每有数据更新，先写入AOF缓冲区，再写入AOF文件中，最后根据持久化方式的配置来决定何时写入磁盘
    
### AOF 工作基本流程是怎样的？

!!! tip "AOF 工作基本流程是怎样的？"
    
    1. 命令追加:写命令会追加到 AOF 缓冲区
    2. 文件写入:缓冲区的数据写入到 AOF 文件中
    3. 文件同步:向硬盘做同步操作,根据持久化方式
    4. 文件重写:随着 AOF 文件越来越大，需要定期对 AOF 文件进行重写，达到压缩的目的
    5. 重启加载:当 Redis 重启时，可以加载 AOF 文件进行数据恢复。
    
### 持久化方式有哪些？

!!! tip "持久化方式有哪些？"
    
    1. write + fsync, 写操作后，后台线程立刻同步aof文件，降低redis性能
    2. write + fsync(every sec)，写操作后，后台线程每秒钟同步一次
    3. write + fsync by system, 写操作后，立即返回。有操作系统决定何时同步，linux一般为30s
    
### AOF 为什么是在执行完命令之后记录日志？

!!! tip "AOF 为什么是在执行完命令之后记录日志？"

    - 避免额外的检查开销，AOF 记录日志不会对命令进行语法检查；
    - 在命令执行完之后再记录，不会阻塞当前的命令执行。
    
    带来了风险
    
    - 如果刚执行完命令 Redis 就宕机会导致对应的修改丢失；
    - 可能会阻塞后续其他命令的执行
    

### AOF 重写了解吗？

!!! tip "AOF 重写了解吗？"

    当 AOF 变得太大时，Redis 能够在后台自动重写 AOF 产生一个新的 AOF 文件，这个新的 AOF 文件体积更小。
    
    新的aof只记录最后一次写的指令，之前那些冗余的操作不会存，所以会较少体积。
    
### 如何选择 RDB 和 AOF？

!!! tip "如何选择 RDB 和 AOF？"

    RDB优秀的点
    
    - 经过压缩，文件小， 虽然aof过大会重写，但是重写期间会大量占用内存
    - 恢复的时候，直接还原数据，速度快，不需要向aof一条条执行命令
    
    AOF优秀的点
    
    - RDB没有aof那么实时，安全性不如aof，而且aof比较轻量，rdb比较吃资源
    - rdb新老版本不兼容
    - AOF比较易于理解和解析
    
    结论：
    - 数据丢失影响不大，可以选择rdb
    - 不建议单独使用aof，恢复起来没有rdb快，如果安全性有要求建议混合使用
    

### Redis应用

!!! tip "Redis应用"

    缓存、分布式锁、限流、消息队列

### 如何基于 Redis 实现分布式锁？

!!! tip "如何基于 Redis 实现分布式锁？"

    setIfAbsent或者SETNX，上锁，最好设置一个过期时间，避免锁未正常释放，锁持久存在。锁过期时间续期可以用Redisson
    
    delete或DEL，解锁
    

### 过期的数据的删除策略了解么？

!!! tip "过期的数据的删除策略了解么？"

    1. 惰性删除：只会在取出 key 的时候才对数据进行过期检查。这样对 CPU 最友好，但是可能会造成太多过期 key 没有被删除。
    2. 定期删除：每隔一段时间抽取一批 key 执行删除过期 key 操作。并且，Redis 底层会通过限制删除操作执行的时长和频率来减少删除操作对 CPU 时间的影响。

    Redis 采用的是 定期删除+惰性删除 。


### Redis 单线程模型了解吗？

!!! tip "Redis 单线程模型了解吗？"

    基于 Reactor 模式设计开发的时间处理模型，对应的是Redis 中的文件事件处理器，它是单线程的

    基于 IO 多路复用来监听客户端的大量连接

    包含四部分

    - 客户端socket连接
    - io多路复用程序。一个线程管理多个客户端连接
    - 事件分派期
    - 事件处理器


### Redis 和 Memcached 的区别和共同点

!!! tip "Redis 和 Memcached 的区别和共同点"

    1. redis支持数据类型多
    2. redis支持持久化，可以灾难恢复
    3. redis支持集群
    4. redis支持pub/sub、lua脚本