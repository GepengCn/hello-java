# 经验

## 问题

- 简单说一下 SQL 调优思路。
- 简单说一下大表优化的思路。
- 什么是读写分离？
- 读写分离会带来什么问题？如何解决？
- 如何实现读写分离？
- 主从复制原理是什么？
- 分库分表了解么？
- 为什么要分库分表？
- 有哪些常见的分库分表工具
- 常见的分片算法有哪些？
- 分库分表会带来什么问题呢？
- 分库分表后，数据怎么迁移呢
- Redis 内存满了怎么办？
- Redis 给缓存数据设置过期时间有啥用？
- Redis 是如何判断数据是否过期的呢？
- Redis过期的数据的删除策略了解么？
- 阅读 Spring 源码的时候什么设计模式最让你影响深刻？能简单讲讲吗？
- 假如有 10 亿个数，只有一个重复，内存只能放下 5 亿个数，怎么找到这个重复的数字？
- 如何设计一个秒杀系统（服务端、数据库、分布式）？分布式系统的设计？
- 有一个服务器专门接收大量请求，怎么设计？
- 如果让你自己设计 RPC 框架你会如何设计？
- 如何设计一个短链系统？


## 答案

### 简单说一下 SQL 调优思路。

!!! tip "简单说一下 SQL 调优思路。"

    - 避免使用select *
    - 数据量较大时，用子查询代替普通分页查询
    - 尽量避免多表join：尽量单表查询，然后再程序中关联，易于后续维护，复用性也强。
    - 尽量不使用外键和级联：分库分表不友好
    - 尽量用union all代替union：union会创建临时表去重，耗时，如果需要去重可以再内存中做。
    - 插入尽量用批量的方式：减少与数据库交互次数
    - 优化慢sql：导出慢sql，使用explain去看是否没走索引
    - 正确的创建索引


### 简单说一下大表优化的思路。

!!! tip "简单说一下大表优化的思路。"

    - 限定数据查询范围不要过大：比如查询一个月的
    - 读写分离：主库负责写，分库负责读
    - 垂直分区：把列比较多的表拆分，相关性强的在一张表。优点：单独查询的时候省资源，也更利于扩展。缺点：需要联表，不过可以再内存中关联
    - 水平分区：表结构不变，数据分片。拆成多个表或多个库中存储

### 什么是读写分离？

!!! tip "什么是读写分离？"

    主数据库负责写，其他的从数据库负责读。主从库同步

### 读写分离会带来什么问题？如何解决？

!!! tip "读写分离会带来什么问题？如何解决？"

    主从同步延迟
    
    解决方案:
    
    1. 强制将读请求路由到主库处理。
    2. 延迟读取。像是支付成功之后跳转到一个支付成功页面，有个倒计时之类的。


### 如何实现读写分离？

!!! tip "如何实现读写分离？"

    1. MySQL Router
    2. sharding-jdbc

### 主从复制原理是什么？

!!! tip "主从复制原理是什么？"

    主库将数据变化写入binlog，然后将binlog同步到从库，从库再执行binlog（相当于执行一遍sql）


### 分库分表了解么？

!!! tip "分库分表了解么？"


    - 分库：水平和垂直。垂直：按业务分不同的库。水平：一张大表分到不同库。
    - 分表：水平和垂直。垂直：按业务分为不同的表，相关性强的在一张表。水平：一张表拆成多个表。

### 为什么要分库分表？

!!! tip "为什么要分库分表？"

    单表数据过大，读写比较慢

### 有哪些常见的分库分表工具

!!! tip "有哪些常见的分库分表工具"

    ShardingSphere

### 常见的分片算法有哪些？

!!! tip "常见的分片算法有哪些？"

    - 哈希分片：根据id哈希，适合随机读写，不适合范围查询
    - 范围分片：按时间、id区间（自增）
    
### 分库分表会带来什么问题呢？

!!! tip "分库分表会带来什么问题呢？"

    - 不同库无法join，只能内存中关联
    - 事务，只能保证单库的，分库无法保证
    - 自增主键id不可用了，得用分布式id

### 分库分表后，数据怎么迁移呢

!!! tip "分库分表后，数据怎么迁移呢"

    - 停机迁移
    - 双写，新老库一起写。如果跟新的是新库没有的数据，还需要先导入那条数据
    - 用canal，通过binlog迁移


### Redis 内存满了怎么办？

!!! tip "Redis 内存满了怎么办？"

    内存淘汰机制

    所有key里，lru、lfu、随机淘汰
    设置了过期的，lru、lfu、随机淘汰、要过期的
    不淘汰，新写入的直接报错

    
### Redis 给缓存数据设置过期时间有啥用？ 

!!! tip "Redis 给缓存数据设置过期时间有啥用？"

    1. 释放内存
    2. 业务功能


### Redis 是如何判断数据是否过期的呢？

!!! tip "Redis 是如何判断数据是否过期的呢？"

    通过过期字典，一个hash结构，key是要过期的对象，value是时间戳
    
### Redis过期的数据的删除策略了解么？

!!! tip "Redis过期的数据的删除策略了解么？"

    1. 惰性删除：查到key的时候才会做过期检查
    2. 定期删除：每隔一段抽取一批
    
    Redis采用两者结合


### 阅读 Spring 源码的时候什么设计模式最让你影响深刻？能简单讲讲吗？

!!! tip "阅读 Spring 源码的时候什么设计模式最让你影响深刻？能简单讲讲吗？"

    - 适配器模式：Spring MVC
    - 模板方法：jdbcTemplate，redisTemplate
    - 代理：aop


### 假如有 10 亿个数，只有一个重复，内存只能放下 5 亿个数，怎么找到这个重复的数字？

!!! tip "假如有 10 亿个数，只有一个重复，内存只能放下 5 亿个数，怎么找到这个重复的数字？"

    将10个数先排序，然后拆分成2分，内存就放得下了

### 如何设计一个秒杀系统（服务端、数据库、分布式）？分布式系统的设计？

!!! tip "如何设计一个秒杀系统（服务端、数据库、分布式）？分布式系统的设计？"

    - 热点数据：找到热点数据，hotkey检测，京东有开源的
    - 静态资源：css js 商品图片，用cdn缓存
    - 核心服务或中间件，做好集群
    - 做好限流
    - 突然的大流量做流量削峰，放入队列慢慢消费
    - 降级，非核心功能关闭，保核心
    - 熔断，如果下游服务一直卡慢，即使熔断，别把上游也卡死
    - 保证一致性：秒杀的商品放入缓存，比如redis，然后减库存通过原子操作（lua脚本）；接口幂等，分布式锁
    - 做好性能测试

### 有一个服务器专门接收大量请求，怎么设计？

!!! tip "有一个服务器专门接收大量请求，怎么设计？"

    - 耗时长的任务拆分出来，可以做异步方案（mq）
    - 高性能框架，比如netty
    - 尽量不要有存储
    - 多点
    - 查询用缓存


### 如果让你自己设计 RPC 框架你会如何设计？

!!! tip "如果让你自己设计 RPC 框架你会如何设计？"

    - 注册中心：保存服务地址，相当于目录
    - 网络传输：可以用Netty开发
    - 序列化：将对象转换二进制数据，反序列化同理
    - 动态代理：屏蔽调用远程的细节
    - 负载均衡
    - 传输协议

### 如何设计一个短链系统？

!!! tip "如何设计一个短链系统？"

    - 通过哈希算法对长链进行哈希
    - 转换进制，缩小长度
    - 存储数据库中判断哈希冲突，或使用布隆过滤器
    - 拼接一个随机字符解决哈希冲突


